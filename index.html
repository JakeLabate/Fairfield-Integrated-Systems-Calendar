<!DOCTYPE html>
<html lang="en">
<head>

	<!-- Title & Meta Data -->
	<meta charset="UTF-8">
	<title>Fairfield Integrated Systems Calendar</title>
	<meta name="robots" content="noindex, nofollow">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="title" content="Fairfield Integrated Systems Calendar">
	<meta name="description" content="Fairfield Integrated Systems Calendar">
	<meta name="author" content="BRANDWIELD Inc. - brandwield@gmail.com - 203-907-5536">
	<meta name="language" content="English">
	<meta name="distribution" content="global">

	<!-- CSS Stylesheet -->
	<link rel="stylesheet" href="stylesheet.css">

	<!-- Firebase Real Time Database -->
	<script type="module">
		console.log("Firebase Real Time Database Script Loaded");
		// Full list of functions: https://firebase.google.com/docs/web/setup#available-libraries
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
		import { getDatabase, ref, child, get, set, push, remove } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

		// Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyA076_DdfgtN-UFPRysbn-3ca7khvOSx6E",
			authDomain: "fairfield-integrated-systems.firebaseapp.com",
			databaseURL: "https://fairfield-integrated-systems-default-rtdb.firebaseio.com",
			projectId: "fairfield-integrated-systems",
			storageBucket: "fairfield-integrated-systems.appspot.com",
			messagingSenderId: "358421826101",
			appId: "1:358421826101:web:b8b89c26da56a64731ff7c"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const db = getDatabase();

		// Get from database
		const dbRef = ref(getDatabase());

		// Get team members
		get(child(dbRef, 'team' )).then((snapshot) => {
			if (snapshot.exists()) {
				console.log(snapshot.val());
			} else {
				console.log("No data available");
			}

			// For all team members, create divs
			console.log('Loading team members...');

			snapshot.forEach((childSnapshot) => {
				var childData = childSnapshot.val();
			//	addTeamMemberToDOM({id: childSnapshot.key, ...childData})

				// Add an 'option' for each vehicle to the 'select' with the #id of 'teamMembersSelect' <-- has an 's' in the #id
				var option = document.createElement("option");
				option.value = childData.firstName + ' ' + childData.lastName;
				document.getElementById("teamMembersSelect").appendChild(option);
				// select the last option added
				document.getElementById('teamMembersSelect').lastElementChild.innerText = childData.firstName + ' ' + childData.lastName;

			});
		});

		// Get vehicles
		get(child(dbRef, 'vehicles' )).then((snapshot) => {
			if (snapshot.exists()) {
				console.log(snapshot.val());
			} else {
				console.log("No data available");
			}

			// For all vehicles, create divs
			console.log('Loading vehicles...');
			snapshot.forEach((childSnapshot) => {
				var childData = childSnapshot.val();

/*				// Create a div for the 'lists' tab
				var vehicle = document.createElement("div");
				vehicle.innerHTML =
					'<div draggable="true" class="card" style="cursor: pointer;">' +
					'<text class="topCardLabel">Vehicle</text><br>' +
					'<text>' + childData.vehicleName + '</text><br>' +
					'<text style="color: var(--secondaryTextColor); font-size: var(--secondaryFontSize);">License: ' + childData.license + '</text><br>' +
					'<text style="color: var(--secondaryTextColor); font-size: var(--secondaryFontSize);">VIN: ' + childData.vin + '</text> <br>' +
					'</div>';

				// Place the div
				document.getElementById("vehicles").appendChild(vehicle);

				// Create a div for the 'today' tab
				var vehicleToday = document.createElement("div");
				vehicleToday.innerHTML =
					'<div draggable="true" class="card" style="cursor: pointer;">' +
					'<text class="topCardLabel">Vehicle</text><br>' +
					'<text>' + childData.vehicleName + '</text><br>' +
					'<text style="color: var(--secondaryTextColor); font-size: var(--secondaryFontSize);">License: ' + childData.license + '</text><br>' +
					'<text style="color: var(--secondaryTextColor); font-size: var(--secondaryFontSize);">VIN: ' + childData.vin + '</text> <br>' +
					'</div>';

				// Place the div
				document.getElementById("vehiclesToday").appendChild(vehicleToday);*/

				// Add an 'option' for each vehicle to the 'select' with the id of 'vehiclesSelect' <-- has an 's' in the #id
				let option = document.createElement('option');
				option.value = childData.vehicleName;
				document.getElementById('vehiclesSelect').appendChild(option);
				// select the last option added
				document.getElementById('vehiclesSelect').lastElementChild.innerText = childData.vehicleName + ' - Lic: ' + childData.license;

				// Console log the created items
				console.log('Vehicle loaded: ' + childData.vehicleName);
			});
		});
		
		// New Team Member
		window.newTeamMember = () => {
			const firstName = document.getElementById("fname").value
			const lastName = document.getElementById("lname").value
			const email = document.getElementById("email").value

			if(!firstName || !lastName || !email) return;

			// Push is used to ensure we don't overwrite the team list
			const teamListRef = child(dbRef, 'team' );
			const newTeamMemberRef = push(teamListRef)
			set(newTeamMemberRef, {firstName, lastName, email})
				.then((res) => {
					addTeamMemberToDOM({firstName, lastName, email, id: newTeamMemberRef.key})
					resetModalForm()
				})
				.catch(err => {
					console.log("Could not create Team member...",err)
				}).finally(toggleModal)
		}

		// Delete Team Member
		window.deleteTeamMember = (id) => {
			if(!id) return;
			if(!confirm("Are you sure you want to delete?")){
				return;
			}
			// Remove from the database
			remove(child(dbRef, `team/${id}`)).then((res) => {
				// Remove from the frontend list
				const toBeDeletedDivs = []
				toBeDeletedDivs.push(document.getElementById(id));
				toBeDeletedDivs.push(document.getElementById(`today-${id}`));
				toBeDeletedDivs.forEach(el => el.parentNode.removeChild(el))
			})
		}
		
		// New Vehicle
		window.newVehicle = () => {
			console.log('Creating new vehicle...');
		}

	</script>

	<!-- JavaScript -->
	<script src="script.js"></script>

</head>
<body>

<main>

	<!-- Tabs -->
	<button class="tablink" onclick="openPage('Assignments', this, 'black')" id="defaultOpen">Assignments</button>
	<button class="tablink" onclick="openPage('Upcoming', this, 'black')">Upcoming</button>
	<button class="tablink" onclick="openPage('Lists', this, 'black')">Lists</button>
	<!-- Refresh Page Button -->
	<button class="tablinkRefresh" onclick="window.location.href = window.location.href"><img src="media/refreshWhite.png" height="16"/></button>

	<!-- Assignments Tab -->
	<section id="Assignments" class="tabcontent">
		<div class="container">

			<!-- Team Members -->
			<div id="teamMembersSection">
				<text> I want </text>
				<select id="teamMembersSelect" class="smallShadow" onchange="updateTeamMember();"></select>
			</div>

			<!-- Vehicles -->
			<div id="vehiclesSection">
				<text> to take the </text>
				<select id="vehiclesSelect" class="smallShadow" onchange="updateVehicle();"></select>
			</div>

			<!-- To Do  -->
			<div id="toDoSection">
				<text> to </text>
				<select id="toDoSelect" class="smallShadow" onchange="updateToDo();">
					<optgroup id="projectsOptgroup" label="Projects (Approved)"></optgroup>
					<optgroup id="tasksOptgroup" label="Tasks"></optgroup>
					<optgroup id="serviceOrdersOptgroup" label="Service Orders"></optgroup>
				</select>
				<div id="Projects"></div>
				<div id="ServiceOrders"></div>
				<div id="Tasks"></div>
			</div>

			<!-- Date -->
			<div id="dateSection">
				<text> on </text>
				<input type="date" id="datePicker" name="date" class="smallShadow" onchange="updateDate();">
			</div>

			<!-- Start Time -->
			<div id="startTimeSection">
				<text> from </text>
				<input type="time" id="startTimePicker" name="startTime" class="smallShadow" value="08:00" onchange="updateStartTime();">
			</div>

			<!-- End Time -->
			<div id="endTimeSection">
				<text> to </text>
				<input type="time" id="endTimePicker" name="endTime" class="smallShadow" value="17:00" onchange="updateEndTime();">
			</div>

			<!-- Display -->
			<!-- The inline JavaScript below is not working -->
			<div id="display" contenteditable="true" class="smallShadow" style="padding: 10px 10px 10px 10px; width: 300px; border: 1px solid #868686; border-radius: 5px;">
				Hi <text class="teamMemberHere" onload="this.innerText = document.getElementById('teamMemberSelect').value"></text>!
				You are assigned to take the <text class="vehicleHere" onload="this.innerText = document.getElementById('vehiclesSelect').value"></text>
				to <text class="toDoHere" onload="this.innerText = document.getElementById('toDoSelect').value"></text>
				on <text class="dateHere" onload="this.innerText = document.getElementById('datePicker').value"></text>
				from <text class="startTimeHere" onload="this.innerText = document.getElementById('startTimePicker').value"></text>
				to <text class="endTimeHere" onload="this.innerText = document.getElementById('endTimePicker').value"></text>!
			</div>

			<!-- Confirm -->
			<div id="confirmSection">
				<button onclick="confirmAssignment();">Confirm</button>
			</div>

		</div>
	</section>

	<!-- Upcoming Tab -->
	<section id="Upcoming" class="tabcontent"></section>

	<!-- Lists Tab -->
	<section id="Lists" class="tabcontent">

		<!-- Vehicles -->
		<div id="vehicles" class="column33Percent" style="margin-top: 35px; max-width: 420px;">
			<h3>Vehicles</h3>
			<!-- Creat New Vehicle -->
			<div id="newVehicle" class="plusIcon" onclick="newVehicle();">
				<img src="media/plus.webp" width="15" height="15">
				<text>New Vehicle</text>
			</div>
		</div>

		<!-- Team Members-->
		<div id="team" class="column33Percent" style="margin-top: 35px; max-width: 420px;">
			<h3>Team Members</h3>
			<!-- Creat New Team Member -->
			<div id="newTeamMember" class="plusIcon" onclick="toggleModal();">
				<img src="media/plus.webp" width="15" height="15">
				<text>New Team Member</text>
			</div>
		</div>

	</section>

</main>

	<!-- Modal for Team Member Details -->
	<div id="modal-team" class="modal" style="display: none;">		
		<form>

			<label for="fname">First Name</label>
			<input type="text" id="fname" name="firstname" placeholder="Your first name.." required>
	
			<label for="lname">Last Name</label>
			<input type="text" id="lname" name="lastname" placeholder="Your last name.." required>

			<label for="email">Email</label>
			<input type="email" id="email" name="email" placeholder="Your Email.." required>

			<div class="modal-actions">
				<button type="button" onclick="toggleModal()">Cancel</button>
				<button type="button" onclick="newTeamMember()" >Save Team Member</button>
			</div>
	
		</form>			          		
	</div>

	<!-- Tabs Script -->
	<script>
		console.log("Tabs Script Loaded");
		function openPage(pageName,elmnt,color) {
			var i, tabcontent, tablinks;

			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].style.display = "none";
			}

			tablinks = document.getElementsByClassName("tablink");
			for (i = 0; i < tablinks.length; i++) {
				tablinks[i].style.backgroundColor = "";
				tablinks[i].style.color = "white";
			}

			document.getElementById(pageName).style.display = "block";
			elmnt.style.backgroundColor = color;
			console.log("'" + pageName + "' Tab Opened");
		}
		// Get the element with id="defaultOpen" and click on it
		document.getElementById("defaultOpen").click();
	</script>

</body>
</html>